<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Friends Group | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚Ø©</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #5c7cfa; --bg: #f8f9fa; --card: #ffffff; --text: #212529;
            --border: #e9ecef; --msg-own: #5c7cfa; --msg-other: #ffffff; --reply-alert: #fa5252;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] {
            --bg: #121212; --card: #1e1e1e; --text: #e9ecef; --border: #333;
            --msg-own: #3b5bdb; --msg-other: #2d2d2d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; color: var(--text); }

        /* 1. Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¨Ù€ 4 Ø£Ø²Ø±Ø§Ø± Ù…ØªÙ†Ø§Ø³Ù‚Ø© */
        header { 
            background: var(--card); padding: 8px 12px; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 1px solid var(--border); z-index: 3000; flex-shrink: 0; 
        }
        .logo { font-weight: 900; color: var(--primary); font-size: 1.2rem; }
        .nav-tools { display: flex; gap: 8px; }
        .btn-tool { 
            background: var(--bg); border: 1px solid var(--border); color: var(--text); width: 40px; height: 40px; 
            border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            text-decoration: none; font-size: 1.1rem; transition: 0.3s; 
        }
        .btn-tool:hover { border-color: var(--primary); transform: translateY(-2px); }

        /* 2. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (ØªØ­Øª Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø¨Ø§Ø´Ø±Ø©) */
        .top-input-area { background: var(--card); border-bottom: 1px solid var(--border); padding: 12px; z-index: 2500; flex-shrink: 0; }
        #reply-status { 
            display: none; background: var(--bg); padding: 8px 15px; border-radius: 12px; 
            justify-content: space-between; align-items: center; margin-bottom: 10px; 
            font-size: 0.8rem; border: 1px solid var(--border); animation: slideIn 0.3s ease;
        }
        .input-bar { display: flex; gap: 10px; flex-direction: row-reverse; align-items: center; justify-content: center; }
        
        /* Ø®Ø§Ù†Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ø§ ØªØªØ¹Ø¯Ù‰ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© (55%) */
        #message-input { 
            flex: 1; max-width: 55%; padding: 12px 20px; border-radius: 25px; border: 1px solid var(--border); 
            background: var(--bg); color: var(--text); outline: none; font-size: 1rem; transition: 0.2s;
        }
        #message-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(92, 124, 250, 0.1); }
        .send-btn { 
            width: 50px; height: 50px; background: var(--primary); border: none; border-radius: 50%; 
            color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
        }
        .send-btn svg { width: 22px; height: 22px; fill: currentColor; transform: rotate(180deg); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
        #search-box { background: var(--card); padding: 8px 15px; display: none; border-bottom: 1px solid var(--border); }

        /* 3. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ø§Ù„Ù…ØµÙ„Ø­ */
        main { flex: 1; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        #chat-messages { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; 
            gap: 15px; -webkit-overflow-scrolling: touch; 
        }

        .msg-wrap { width: 100%; display: flex; flex-direction: column; transition: transform 0.1s linear; position: relative; will-change: transform; }
        
        /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ÙŠØ³Ø§Ø± (Ø£Ù†Øª) - ÙŠÙ…ÙŠÙ† (Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†) */
        .message { max-width: 80%; padding: 12px 18px; border-radius: 22px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; cursor: pointer; }
        .message.own { align-self: flex-start; background: var(--msg-own); color: white; border-bottom-left-radius: 4px; }
        .message.other { align-self: flex-end; background: var(--msg-other); color: var(--text); border-bottom-right-radius: 4px; border: 1px solid var(--border); }
        
        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ù„Ùƒ Ø¨Ø§Ù„Ø£Ø­Ù…Ø± */
        .message.reply-to-me { background: var(--reply-alert) !important; color: white !important; }

        .sender-tag { font-size: 0.7rem; font-weight: 900; margin-bottom: 4px; cursor: pointer; color: var(--primary); }
        .reply-quote { background: rgba(0,0,0,0.1); border-right: 4px solid var(--primary); padding: 6px; border-radius: 8px; font-size: 0.75rem; margin-bottom: 6px; }

        /* 4. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Boundary Fix) */
        #ctx-menu { 
            position: fixed; background: var(--card); border: 1px solid var(--border); border-radius: 15px; 
            display: none; z-index: 6000; width: 200px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
        }
        .menu-item { padding: 14px 18px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .menu-item:hover { background: var(--bg); }
        .menu-item.danger { color: #fa5252; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
        .join-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .join-card { 
            background: var(--card); padding: 35px; border-radius: 30px; width: 100%; 
            max-width: 420px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: fadeInUp 0.5s ease;
        }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-box { background: var(--card); width: 100%; max-width: 420px; border-radius: 28px; padding: 30px; text-align: center; max-height: 85vh; display: flex; flex-direction: column; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="logo">Friends Group</div>
        <div class="nav-tools">
            <button class="btn-tool admin-only hidden" onclick="openMembersList()">ğŸ‘¥</button>
            <button class="btn-tool" onclick="toggleSearch()">ğŸ”</button>
            <button class="btn-tool" onclick="toggleTheme()">ğŸŒ™</button>
            <a href="tg://openmessage?user_id=" class="btn-tool">ğŸ‘¤</a>
        </div>
    </header>

    <div class="top-input-area">
        <div id="reply-status">
            <span id="reply-info-text">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: ...</span>
            <span onclick="cancelReply()" style="cursor:pointer; font-weight:bold; font-size:1.2rem;">âœ•</span>
        </div>
        <div class="input-bar">
            <input type="text" id="message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." autocomplete="off">
            <button class="send-btn" onclick="sendMessage()">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </div>
    </div>

    <div id="search-box">
        <input type="text" id="chat-search" style="width:100%; padding:10px 15px; border-radius:20px; border:1px solid var(--border); background:var(--bg); color:var(--text); outline:none;" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´Ø§Øª..." oninput="filterChat()">
    </div>

    <div id="join-overlay" class="join-overlay">
        <div class="join-card">
            <h2 style="color:var(--primary); margin-bottom:10px;">Ø§Ù†Ø¶Ù… Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h2>
            <p id="join-status" style="font-size:0.9rem; color:#888; margin-bottom:20px;">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø± Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</p>
            <input type="text" id="username-input" style="width:100%; padding:15px; border-radius:15px; border:2px solid var(--border); margin-bottom:20px; outline:none;" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...">
            <button id="join-btn" class="send-btn" style="width:100%; border-radius:15px; font-weight:bold;" onclick="handleJoin()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>

    <main><div id="chat-messages"></div></main>

    <div id="owner-modal" class="modal">
        <div class="modal-box">
            <h3>ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
            <input type="password" id="owner-pass" style="width:100%; padding:15px; margin:20px 0; border-radius:10px; border:1px solid var(--border);" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø®Ø§ØµØ©...">
            <button class="send-btn" style="width:100%; border-radius:10px;" onclick="verifyOwner()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©</button>
            <button onclick="closeModals()" style="margin-top:10px; border:none; background:none; color:gray;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="members-modal" class="modal">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px;">
                <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
                <span onclick="closeModals()" style="cursor:pointer; font-size:1.5rem;">âœ•</span>
            </div>
            <div id="members-list-content" style="flex:1; overflow-y:auto; margin-top:15px;"></div>
        </div>
    </div>

    <div id="ctx-menu">
        <div class="menu-item" onclick="deleteMessage()">Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©</div>
        <div class="menu-item admin-only hidden" id="menu-ban" onclick="banUser()">Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        <div class="menu-item admin-only hidden" id="menu-mod" onclick="toggleMod()">ØªØ±Ù‚ÙŠØ©/Ø¹Ø²Ù„ Ù…Ø´Ø±Ù</div>
    </div>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAYj5wYf4-Ot4AEjQ9bdxBP7O20YcUgvVg",
            authDomain: "project-ef0e4.firebaseapp.com",
            projectId: "project-ef0e4",
            storageBucket: "project-ef0e4.firebasestorage.app",
            messagingSenderId: "723951659624",
            appId: "1:723951659624:web:869d6c5d5b39c31f7a29dd",
            measurementId: "G-PZ99ZKYPND"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Ø§Ù„Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const MASTER_PASSWORD = "1000Kms1000#";
        const SUPER_ADMIN = "ÙƒØ±ÙŠÙ…";
        
        let currentUser = localStorage.getItem('chat_user');
        let myRole = 'user';
        let replyReference = null;
        let selectedMsgId = null;
        let selectedMsgUser = null;
        let cachedMessages = [];

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ---
        async function handleJoin() {
            let name = document.getElementById('username-input').value.trim();
            if(!name) return;
            
            let finalName = name;
            let counter = 1, exists = true;
            while(exists) {
                const doc = await db.collection("users").doc(finalName).get();
                if(doc.exists && finalName !== name) { counter++; finalName = name + " " + counter; }
                else if(doc.exists && name !== SUPER_ADMIN) { finalName = name + " " + counter; counter++; }
                else { exists = false; }
            }

            if(finalName !== name) {
                document.getElementById('join-status').innerText = `Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ù‚ØªØ±Ø­: ${finalName}`;
                document.getElementById('username-input').value = finalName;
                document.getElementById('join-btn').innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ù…Ù‚ØªØ±Ø­";
                return;
            }

            await db.collection("users").doc(finalName).set({ name: finalName, role: (finalName === SUPER_ADMIN ? 'super' : 'user') }, {merge:true});
            localStorage.setItem('chat_user', finalName);
            location.reload();
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ø±Ø¯ Ø¨Ø§Ù„Ø³Ø­Ø¨ ---
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;

            // Ø£Ù…Ø± Ø§Ù„Ù…Ø§Ù„Ùƒ
            if(text === ".Ø§Ù†Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ") { document.getElementById('owner-modal').style.display = 'flex'; input.value = ''; return; }
            
            // Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ù…Ø§Ø³ØªØ± Ù„ÙƒØ±ÙŠÙ…
            if(text === ".Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„" && myRole === 'super') {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
                    const snp = await db.collection("messages").get();
                    const batch = db.batch();
                    snp.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                }
                input.value = ''; return;
            }

            db.collection("messages").add({
                user: currentUser, text: text, replyTo: replyReference, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            cancelReply();
            input.value = '';
        }

        function triggerReply(msg) {
            replyReference = msg;
            document.getElementById('reply-status').style.display = 'flex';
            document.getElementById('reply-info-text').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${msg.user}: ${msg.text.substring(0,12)}...`;
            document.getElementById('message-input').focus();
            if(window.navigator.vibrate) window.navigator.vibrate(40);
        }
        function cancelReply() { replyReference = null; document.getElementById('reply-status').style.display = 'none'; }

        // --- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© ---
        function loadMessages() {
            db.collection("messages").orderBy("timestamp", "desc").limit(100).onSnapshot(snap => {
                const container = document.getElementById('chat-messages');
                cachedMessages = [];
                snap.forEach(doc => cachedMessages.push({id: doc.id, ...doc.data()}));
                renderMessages(cachedMessages);
            });
        }

        function renderMessages(msgs) {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            msgs.slice().reverse().forEach(msg => {
                const isOwn = msg.user === currentUser;
                const isRepliedToMe = msg.replyTo && msg.replyTo.user === currentUser;
                const wrap = document.createElement('div');
                wrap.className = 'msg-wrap';
                
                // --- Ø§Ø³ØªØ´Ø¹Ø§Ø± Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø·ÙˆØ± ---
                let startX = 0, currentX = 0, isSwiping = false;
                wrap.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; isSwiping = true; }, {passive: true});
                wrap.addEventListener('touchmove', (e) => {
                    if(!isSwiping) return;
                    currentX = e.touches[0].clientX - startX;
                    if(currentX > 0) wrap.style.transform = `translateX(${Math.min(currentX, 90)}px)`;
                }, {passive: true});
                wrap.addEventListener('touchend', () => {
                    if(currentX > 100) triggerReply(msg);
                    wrap.style.transform = 'translateX(0)'; isSwiping = false; currentX = 0;
                });

                wrap.innerHTML = `
                    <div class="message ${isOwn ? 'own' : 'other'} ${isRepliedToMe ? 'reply-to-me' : ''}" 
                         oncontextmenu="event.preventDefault(); openContextMenu(event, '${msg.id}', '${msg.user}')">
                        <div class="sender-tag" onclick="addMention('${msg.user}')">${msg.user}</div>
                        ${msg.replyTo ? `<div class="reply-quote"><strong>${msg.replyTo.user}:</strong> ${msg.replyTo.text.substring(0,20)}...</div>` : ''}
                        <div>${msg.text}</div>
                    </div>
                `;
                container.appendChild(wrap);
            });
            container.scrollTop = container.scrollHeight;
        }

        // --- Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø®Ø±ÙˆØ¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© ---
        function openContextMenu(e, id, user) {
            selectedMsgId = id; selectedMsgUser = user;
            const menu = document.getElementById('ctx-menu');
            const menuWidth = 200, menuHeight = 120;
            let posX = (e.pageX || e.touches[0].pageX);
            let posY = (e.pageY || e.touches[0].pageY);

            // ÙØ­Øµ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙ…Ù†Ù‰ ÙˆØ§Ù„ÙŠØ³Ø±Ù‰ ÙˆØ§Ù„Ø³ÙÙ„ÙŠØ©
            if (posX + menuWidth > window.innerWidth) posX = window.innerWidth - menuWidth - 10;
            if (posX < 10) posX = 10;
            if (posY + menuHeight > window.innerHeight) posY = window.innerHeight - menuHeight - 10;

            const isAdmin = (myRole === 'super' || myRole === 'mod');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
            
            menu.style.display = 'block'; menu.style.left = posX + 'px'; menu.style.top = posY + 'px';
        }

        // --- Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Øª ---
        async function verifyOwner() {
            if(document.getElementById('owner-pass').value === MASTER_PASSWORD) {
                await db.collection("users").doc(currentUser).update({ role: 'super' });
                alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ!"); location.reload();
            } else alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±!");
        }

        async function openMembersList() {
            document.getElementById('members-modal').style.display = 'flex';
            const snp = await db.collection("users").get();
            const container = document.getElementById('members-list-content');
            container.innerHTML = '';
            snp.forEach(doc => {
                const u = doc.data();
                const row = document.createElement('div');
                row.className = 'member-row';
                row.innerHTML = `<span>${u.name} (${u.role || 'user'})</span>
                    ${myRole==='super' && u.name !== SUPER_ADMIN ? `<button onclick="actionBan('${u.name}')" style="color:red; background:none; border:1px solid red; padding:5px; border-radius:5px;">Ø­Ø¸Ø±</button>` : ''}`;
                container.appendChild(row);
            });
        }

        function deleteMessage() { db.collection("messages").doc(selectedMsgId).delete(); hideMenu(); }
        function hideMenu() { document.getElementById('ctx-menu').style.display = 'none'; }
        function addMention(name) { document.getElementById('message-input').value += `@${name} `; document.getElementById('message-input').focus(); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function toggleSearch() { const b = document.getElementById('search-box'); b.style.display = (b.style.display === 'block') ? 'none' : 'block'; }
        function filterChat() { const q = document.getElementById('chat-search').value.toLowerCase(); renderMessages(cachedMessages.filter(m => m.text.toLowerCase().includes(q))); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        window.onclick = hideMenu;

        // Ø¯Ø¹Ù… Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ù…ØªÙØ§Ø¹Ù„
        if(window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.body.style.height = window.visualViewport.height + 'px';
                window.scrollTo(0, 0);
            });
        }

        if(currentUser) {
            document.getElementById('join-overlay').classList.add('hidden');
            db.collection("users").doc(currentUser).get().then(doc => {
                myRole = doc.data()?.role || 'user';
                if(myRole === 'super' || myRole === 'mod') document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            });
            loadMessages();
        }
    </script>
</body>
</html>
